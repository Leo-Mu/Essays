# 技术路线与设计方案

为支持和承载本产品多方参与、商家进驻量大、用户的环保成就感需要等特点，选择了“区块链+”的技术路线，以联盟链为底层。为尽可能多地覆盖用户群体以及未来的可扩展空间，基于跨平台框架 Flutter 作 app 端开发。

## 技术架构

### 区块链

区块链具有去中心化、去信任、集体维护、不可篡改等特点，能够建立多方信任共识。考虑到商家进驻量大，彼此之间信任度不足，并且需要传递很多商业和用户隐私信息，例如优惠和地理位置等，而我们的平台也并非巨头能达到无条件信任，因此采取联盟链的方式，能够保证所有节点共同维护一个不可篡改的信任共识，达成合作的同时对部分数据的访问权进行管理。

另一方面，由于区块链的不可篡改性和长期保存性，用户碳积分、卡牌图鉴、元素精灵和优惠券资产可以受到可靠的维护。每一个用户都是独一无二的，每一个用户的数据都将会在本平台上妥善管理永久保存。特别是用户在使用本产品过程中碳足迹为环保做出的改变，为地球做出的贡献，将会以地区和赛季的形式量化为纪念意义的成就勋章，被区块链永远铭记。即使有一天本平台停止维护，任何参与者仍然可以通过区块链查证的方式确认其有效性。

#### 节点

支付系统、交通系统、合作商家为实际参与区块链运行的节点，根据区块链的共识算法达成网络状态（数据库）共识。同时他们也会有专用的组织账户进行资产兑现转移、数据授权交换等发放和核准工作。

节点的部署工作可由进驻组织委托我们在我们的平台上运行或由我们作为技术支持在各组织自己的物理设备上进行搭建。（设计物理设备的掌控权问题，如果无法无条件信任则应自行搭建区块链节点）

#### 用户

参与本产品的八维通用户为用户。此用户为区块链上的使用者账户，是虚拟的数据概念。每个用户有独一无二的私约进行身份识别、管理和保护，作为资产和成就的凭据，由严格的密码学证明保证其有效性。私钥暂时由本产品后端进行生成和管理，后续可以开放给有能力的用户直接进行生成和替换。（私钥一经丢失无法补办）

#### 区块链架构

基于 Hyperledger Fabric 进行部署。 Hyperledger Fabric 是由 Linux 基金会领导的主要由 IBM 和 Digital Asset 开发的高可靠、高性能、易拓展的联盟链框架。本产品会为各组织提供一个方便的一键部署工具。

#### 智能合约

智能合约即 Fabric 联盟链上实际运行的链码，是本区块链模块的核心。数据库结构、用户资产的交易和证明逻辑都蕴含其中，具体包括：

- 碳积分合约（基础合约）
    - 记录碳积分
    - 发放碳积分
    - 碳积分转账
    - ![碳积分合约](/images/2020/05/碳积分合约.svg)
- 卡牌合约（调用碳积分合约）
    - 记录卡牌
    - 抽取卡牌
    - 转移卡牌
    - ![卡牌合约](/images/2020/05/卡牌合约.svg)
- 优惠合约（调用碳积分合约、卡牌合约）
    - 记录优惠券
    - 兑换优惠券
    - 转移优惠券
    - ![优惠合约](/images/2020/05/优惠合约.svg)
- 交易合约（调用碳积分合约、卡牌合约和优惠合约）
    - 交易卡牌
    - 交易优惠券
    - ![交易合约](/images/2020/05/交易合约.svg)
- 勋章合约
    - 记录勋章
    - 发放勋章
    - 查看勋章
    - ![勋章合约](/images/2020/05/勋章合约.svg)
- 收藏及合成合约（调用碳积分合约和卡牌合约）
    - 记录图鉴
    - 合成卡牌
    - ![收藏及合成合约](/images/2020/05/收藏及合成合约.svg)

其确保了最核心的业务逻辑按照设计执行，产生出由区块链背书的可靠结果，通过区块链的共识算法得出多方信任执行结果作为共识。选用 nodejs 写成，是 Fabric 所支持的三种语言之一，易读易理解易修改，能够使得各个组织的技术人员确认和信任其逻辑。

### 用户后端

由于用户并非节点，无法直接访问区块链，因此从区块链中获取的数据需要被一个中间层转送至用户的客户端，同理用户的资产操作和积分积累也需要由这个中间层验证并写入区块链。用户后端负责查询区块链，给出客户端能够直接访问的 API ，以及写入 API 负责接收和核验由客户端发送的操作并写入区块链。同时用户后端维护一个八维通账户与链上账户之间的映射关系。

用户后端选用 Java 技术栈，作为流行的后端技术栈，也为 Fabric 所支持的两种 application SDK 之一。

### 客户端

客户端为用户所实际使用的 app，作为展示和使用产品功能的前端界面，是最终直接触达用户的门面。客户端从用户后端获取数据进行呈现并将用户的操作等信息反馈上传至用户后端。

客户端选用 Flutter 框架使用 Dart 语言进行开发。Flutter 和 Dart 是 Google 开发的开源移动应用软件开发工具包，支持 Android、iOS、 Windows、Mac、Linux、Google Fuchsia 以及 web 应用开发，跨平台能力极强，可以真正实现一次编码到处运行。同时 Flutter 还内置了 Google ARCore，可以非常方便地进行 VR/AR 应用开发，为未来更好地进行勋章、卡牌、精灵以及 PVE 和 PVP 的展示留出拓展空间。

### 商家端

用户端有 GUI 功能界面，节点同样需要有 GUI 使用界面方便普通店员进行操作。此商家端界面主要为商家端进行开发和服务，连接对应组织自己的节点服务器，以组织账户身份获取数据或进行操作。

此商家端同样选用和客户端一致的 Flutter 框架进行开发。

接入的支付系统、交通系统组织由于是数据化对接自动处理，不需要人为干预因此不需要开发 GUI 客户端，同时本着对他们的敏感保密数据负责的立场，他们的数据库与区块链之间的对接我们仅提供技术支持。
